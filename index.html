<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ICL SAFE â€¢ AI</title>

  <!-- PWA hooks (×›×‘×¨ ×™×© ×œ×š ××ª ×”×§×‘×¦×™× ×”××œ×• ×‘×¨×™×¤×•) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>

  <!-- Theme -->
  <style>
    :root{
      --bg:#0b1220; --panel:#0f182b; --panel2:#111a2b; --muted:#a8b3c7; --text:#e6f2ff;
      --primary:#32d5f2; --primary-2:#11b3d9; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --border:rgba(255,255,255,.08);
      --ring:#0ce6ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--primary)}
    .muted{color:var(--muted)}
    .container{max-width:1100px; margin:0 auto; padding:14px}
    header{position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(9,17,31,.92), rgba(9,17,31,.75)); border-bottom:1px solid var(--border); backdrop-filter:saturate(180%) blur(8px)}
    header .inner{display:flex; align-items:center; gap:10px; padding:10px 14px}
    header img{border-radius:8px}
    header .title{font-weight:800; letter-spacing:.3px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .panel{background:var(--panel2); border:1px solid var(--border); border-radius:16px}
    .row{display:flex; gap:12px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:760px){ .grid-2,.grid-3{grid-template-columns:1fr} }

    .input, select.input, textarea.input{
      width:100%; background:#0d1626; color:var(--text);
      border:1px solid var(--border); border-radius:12px; outline:none;
      font-size:clamp(12px,2.6vw,15px); padding:10px 12px;
    }
    .input:focus{box-shadow:0 0 0 2px var(--ring)}

    .btn, .btn-small{
      border:1px solid var(--border); border-radius:12px; cursor:pointer;
      color:var(--text); background:#14243a;
      font-weight:700; transition:transform .12s ease, border-color .12s ease, opacity .12s ease;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
    }
    .btn{padding:10px 14px; font-size:clamp(12px,2.4vw,15px)}
    .btn-small{padding:8px 10px; font-size:clamp(11px,2.2vw,14px)}
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
    .btn-primary{background:linear-gradient(180deg, var(--primary), var(--primary-2)); border-color:transparent; color:#062029}
    .btn-danger{background:linear-gradient(180deg, #ff6b6b, #ef4444); border-color:transparent}
    .btn-ok{background:linear-gradient(180deg, #41e3a7, #10b981); border-color:transparent; color:#062019}

    /* Tabs */
    .tabs{display:flex; gap:8px; padding:10px}
    .tab{padding:10px 12px; border-radius:10px; cursor:pointer; user-select:none; border:1px solid var(--border); color:var(--muted)}
    .tab.active{background:linear-gradient(180deg, rgba(50,213,242,.15), rgba(17,179,217,.05)); color:var(--text); border-color:rgba(255,255,255,.18)}

    /* Login */
    #authView .box{max-width:420px; margin:8vh auto; padding:18px}

    /* Registration */
    #regView .box{max-width:820px; margin:18px auto; padding:18px}

    /* SOS round buttons */
    .sos-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px; padding:14px}
    .sos-btn{
      position:relative; aspect-ratio:1/1; border-radius:999px; border:none; cursor:pointer;
      background:radial-gradient(60% 60% at 50% 35%, rgba(255,255,255,.18), rgba(255,255,255,.02)),
                 conic-gradient(from 220deg, var(--primary), var(--primary-2));
      color:#03171d; font-weight:900; font-size:34px; display:flex; align-items:center; justify-content:center;
      box-shadow:0 12px 30px rgba(0,0,0,.35), inset 0 0 40px rgba(255,255,255,.08);
      outline:1px solid rgba(255,255,255,.08);
      transition:transform .08s ease, box-shadow .12s ease;
    }
    .sos-btn:active{transform:scale(.98)}
    .sos-label{position:absolute; bottom:-8px; left:0; right:0; text-align:center; font-size:12px; color:var(--muted)}

    /* Log */
    #logList{padding:8px 14px}
    .log-row{display:grid; grid-template-columns: 110px 1fr; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border)}
    .tag{font-size:12px; padding:2px 7px; border-radius:999px; display:inline-block}
    .t-fire{background:#2b0d0d; color:#ffb3b3}
    .t-med{background:#0d1f2b; color:#b3e5ff}
    .t-sec{background:#14112b; color:#c7b3ff}
    .t-env{background:#0c2318; color:#b3ffdb}
    .empty{color:#93a3bd; padding:10px}

    /* Floating tools (optional admin) */
    #peopleBtn{position:fixed; right:16px; bottom:16px; z-index:30; padding:12px 14px; border:none; border-radius:999px;
      background:linear-gradient(180deg, var(--primary), var(--primary-2)); color:#00131a; font-weight:800; box-shadow:0 10px 24px rgba(0,0,0,.18)}
    #peopleBtn.hidden{display:none}

    /* Modal */
    .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40; align-items:center; justify-content:center}
    .modal.show{display:flex}
    .modal .content{background:var(--panel2); border:1px solid var(--border); border-radius:16px; width:min(1100px,92vw); max-height:88vh; overflow:auto}
  </style>
</head>
<body>

<header>
  <div class="inner container">
    <img src="icons/icon-192.png" alt="ICL" width="28" height="28">
    <div class="title">ICL SAFE â€¢ AI</div>
    <div style="margin-inline-start:auto; opacity:.8; font-size:12px">PWA â€¢ Offline</div>
  </div>
</header>

<main class="container">

  <!-- AUTH VIEW -->
  <section id="authView">
    <div class="card box">
      <h2 style="margin:0 0 10px">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
      <div class="col">
        <label>××¡×¤×¨ ××™×©×™ (UserName)</label>
        <input id="login_user" class="input" placeholder="×œ×“×•×’××”: 123456" inputmode="numeric" />
        <label>×¡×™×¡××” (Password)</label>
        <input id="login_pass" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        <button id="login_btn" class="btn btn-primary">×›× ×™×¡×”</button>
        <div class="muted" style="font-size:12px">××™×Ÿ ×œ×š ××©×ª××©? <a id="linkReg" href="#">Registration</a></div>
        <div id="login_msg" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </section>

  <!-- REGISTRATION VIEW -->
  <section id="regView" style="display:none">
    <div class="card box">
      <h2 style="margin:0 0 10px">Registration â€” ×™×¦×™×¨×ª ××©×ª××©</h2>
      <div class="grid grid-2">
        <div class="col">
          <label>××¡×¤×¨ ××™×©×™ (UserName) *</label>
          <input id="r_user" class="input" inputmode="numeric" placeholder="××¡×¤×¨ ××™×©×™"/>
        </div>
        <div class="col">
          <label>×¡×™×¡××” *</label>
          <input id="r_pass" class="input" type="password" placeholder="×‘×—×¨ ×¡×™×¡××”"/>
        </div>
        <div class="col">
          <label>×©× ××œ× *</label>
          <input id="r_name" class="input" placeholder="×©× ××œ×"/>
        </div>
        <div class="col">
          <label>× ×™×™×“</label>
          <input id="r_phone" class="input" inputmode="tel" placeholder="05X-XXXXXXX"/>
        </div>
        <div class="col">
          <label>×ª×¤×§×™×“</label>
          <input id="r_role" class="input" placeholder="×ª×¤×§×™×“"/>
        </div>
        <div class="col">
          <label>××–×•×¨ / ××¤×¢×œ</label>
          <input id="r_area" class="input" placeholder="××–×•×¨"/>
        </div>
        <div class="col">
          <label>×ª×—× ×” / ×¢××“×ª ×¢×‘×•×“×”</label>
          <input id="r_station" class="input" placeholder="×ª×—× ×”"/>
        </div>
        <div class="col">
          <label>××™××™×™×œ</label>
          <input id="r_email" class="input" inputmode="email" placeholder="name@example.com"/>
        </div>
      </div>
      <div class="row" style="justify-content:flex-start; margin-top:8px; gap:10px">
        <button id="reg_save" class="btn btn-ok">×©××™×¨×” ×•×›× ×™×¡×”</button>
        <button id="reg_cancel" class="btn">×‘×™×˜×•×œ</button>
        <div id="reg_msg" class="muted"></div>
      </div>
      <div class="muted" style="margin-top:8px; font-size:12px">
        ×”×¢×¨×”: × ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ (×œ×¦×¨×›×™ ×“××•). ×œ×¤×¨×•×“×§×©×Ÿ × ×“×¨×© ×©×¨×ª/××™××•×ª ××¨×’×•× ×™.
      </div>
    </div>
  </section>

  <!-- APP VIEW -->
  <section id="appView" style="display:none">
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="sos">SOS</div>
      <div class="tab" data-tab="log">×™×•××Ÿ ×§×¨×™××•×ª</div>
      <div class="tab" data-tab="profile">×¤×¨×•×¤×™×œ</div>
      <div style="margin-inline-start:auto"></div>
      <button id="logoutBtn" class="btn-small">×”×ª× ×ª×§</button>
    </div>

    <!-- SOS -->
    <div id="tab_sos" class="panel" style="padding:8px">
      <div class="sos-grid">
        <button class="sos-btn" data-type="FIRE" aria-label="××© ğŸ”¥">ğŸ”¥<div class="sos-label">××©</div></button>
        <button class="sos-btn" data-type="MED" aria-label="×¨×¤×•××” ğŸ©º">ğŸ©º<div class="sos-label">×¨×¤×•××”</div></button>
        <button class="sos-btn" data-type="SEC" aria-label="×‘×™×˜×—×•×Ÿ ğŸ›¡ï¸">ğŸ›¡ï¸<div class="sos-label">×‘×™×˜×—×•×Ÿ</div></button>
        <button class="sos-btn" data-type="ENV" aria-label="×¡×‘×™×‘×” ğŸŒ¿">ğŸŒ¿<div class="sos-label">×¡×‘×™×‘×”</div></button>
      </div>
      <div class="muted" style="padding:0 14px 10px; font-size:12px">×œ×—×™×¦×” ×ª×•×¡×™×£ ×¨×©×•××” ×œ×™×•××Ÿ ×”×§×¨×™××•×ª ×¢× ×ª××¨×™×š ×•×©×¢×ª ×”×œ×—×™×¦×” + ×”××©×ª××© ×”××—×•×‘×¨.</div>
    </div>

    <!-- LOG -->
    <div id="tab_log" class="panel" style="padding:8px; display:none">
      <div class="row" style="gap:8px; padding:8px 6px 0 6px">
        <button id="clearLog" class="btn btn-danger">××™×¤×•×¡ ×™×•××Ÿ</button>
      </div>
      <div id="logList"></div>
    </div>

    <!-- PROFILE (read-only summary from registration) -->
    <div id="tab_profile" class="panel" style="padding:14px; display:none">
      <h3 style="margin:4px 0 10px">×¤×¨×˜×™ ××©×ª××©</h3>
      <div id="profileBox" class="grid grid-3"></div>
    </div>
  </section>

</main>

<!-- (××•×¤×¦×™×•× ×œ×™) ×›×¤×ª×•×¨ ×‘× ×§ ×× ×©×™× ×œ×× ×”×œ×™× â€“ ××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ -->
<button id="peopleBtn" class="hidden">ğŸ‘¥ ×‘× ×§ ×× ×©×™×</button>
<div id="peopleModal" class="modal" aria-hidden="true">
  <div class="content" style="padding:14px">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">×‘× ×§ ×× ×©×™× (×œ×•×’ ××§×•××™)</h3>
      <button id="peopleClose" class="btn-small">×¡×’×•×¨</button>
    </div>
    <div id="peopleList" style="padding:8px 4px"></div>
  </div>
</div>

<script>
/* ===== STORAGE KEYS ===== */
const K_USERS = 'icl_users_v1';          // [{user, pass, name, phone, role, area, station, email, createdAt}]
const K_SESSION = 'icl_session_v1';      // {user}
const K_PEOPLE = 'icl_people_v1';        // [{id/name/phone/...}]
const K_LOG = 'icl_safety_entries_v6';   // [{ts,type,user}]
const K_ONBOARD = 'icl_onboard_done_v1'; // (× ×©××¨ ××•×˜×•××˜×™×ª ××—×¨×™ Registration)
/* ===== HELPERS ===== */
const $ = (s,root)=> (root||document).querySelector(s);
const el = (tag,attrs={}) => Object.assign(document.createElement(tag), attrs);
const nowISO = ()=> new Date().toISOString();
const read = (k, fb) => { try { return JSON.parse(localStorage.getItem(k) ?? fb); } catch { return JSON.parse(fb); } };
const write = (k,v)=>{ try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const append = (k, obj)=>{ const arr=read(k,'[]'); arr.push(obj); write(k,arr); return arr; };
const phoneIL = v => /^05\d-?\d{7}$/.test(String(v||'').trim());

/* ===== AUTH / NAV ===== */
function show(viewId){
  $('#authView').style.display = (viewId==='auth')?'block':'none';
  $('#regView').style.display  = (viewId==='reg') ?'block':'none';
  $('#appView').style.display  = (viewId==='app') ?'block':'none';
}
function setTab(name){
  document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
  $('#tab_sos').style.display = (name==='sos')?'block':'none';
  $('#tab_log').style.display = (name==='log')?'block':'none';
  $('#tab_profile').style.display = (name==='profile')?'block':'none';
}

/* ===== USERS / PEOPLE ===== */
function findUser(user){ return read(K_USERS,'[]').find(u => String(u.user)===String(user)); }
function upsertPerson(p){
  const list = read(K_PEOPLE, '[]');
  const key = p.id || p.user || p.name;
  const i = list.findIndex(x => (x.id||x.user||x.name)===key);
  if (i>-1) list[i] = {...list[i], ...p, updatedAt: nowISO()};
  else list.push({...p, updatedAt: nowISO()});
  write(K_PEOPLE, list);
}
function renderPeopleModal(){
  const box = $('#peopleList'); const arr = read(K_PEOPLE,'[]');
  if (!arr.length) { box.innerHTML = '<div class="empty">××™×Ÿ × ×ª×•× ×™×.</div>'; return; }
  box.innerHTML = arr.map(p => `
    <div class="log-row" style="grid-template-columns: 160px 1fr">
      <div class="muted">${p.user||p.id||'-'}</div>
      <div><b>${p.name||'-'}</b> Â· ${p.phone||''} Â· ${p.role||''} Â· ${p.area||''}${p.station?(' Â· '+p.station):''}</div>
    </div>`).join('');
}

/* ===== PROFILE BOX ===== */
function renderProfile(user){
  const u = findUser(user); if (!u) return;
  const fields = [
    ['××¡×¤×¨ ××™×©×™', u.user], ['×©× ××œ×', u.name], ['× ×™×™×“', u.phone||'-'],
    ['×ª×¤×§×™×“', u.role||'-'], ['××–×•×¨', u.area||'-'], ['×ª×—× ×”', u.station||'-'],
    ['××™××™×™×œ', u.email||'-'], ['× ×•×¦×¨', new Date(u.createdAt).toLocaleString('he-IL')]
  ];
  const box = $('#profileBox');
  box.innerHTML = fields.map(([k,v]) => `
    <div class="card" style="padding:12px"><div class="muted" style="font-size:12px">${k}</div><div>${v||'-'}</div></div>
  `).join('');
}

/* ===== LOG ===== */
function renderLog(){
  const list = read(K_LOG,'[]').slice().reverse(); // ××—×¨×•× ×•×ª ×¨××©×•× ×•×ª
  const wrap = $('#logList');
  if (!list.length){ wrap.innerHTML = '<div class="empty">××™×Ÿ ×§×¨×™××•×ª ×‘×™×•××Ÿ.</div>'; return; }
  wrap.innerHTML = list.map(e=>{
    const d = new Date(e.ts);
    const time = d.toLocaleString('he-IL');
    const tag = e.type==='FIRE'?'t-fire': e.type==='MED'?'t-med': e.type==='SEC'?'t-sec':'t-env';
    const label = {FIRE:'××©', MED:'×¨×¤×•××”', SEC:'×‘×™×˜×—×•×Ÿ', ENV:'×¡×‘×™×‘×”'}[e.type]||e.type;
    return `<div class="log-row">
      <div><span class="tag ${tag}">${label}</span></div>
      <div>${time} â€” ×¢×´×™ ${e.user || '-'}</div>
    </div>`;
  }).join('');
}
function hardResetLog(){
  if (!confirm('×œ××¤×¡ ××ª ×”×™×•××Ÿ?')) return;
  // ××•×—×§ ×›×œ ××¤×ª×—×•×ª ×’×¨×¡××•×ª ×™×©× ×•×ª + ×¤×¨×•×¤×™×œ×™×
  ['icl_safety_entries_v1','icl_safety_entries_v2','icl_safety_entries_v3','icl_safety_entries_v4','icl_safety_entries_v5','icl_safety_entries_v6',
   'icl_safety_profile_v1','icl_safety_profile_v2','icl_safety_profile_v3','icl_safety_profile_v4','icl_safety_profile_v5',
   'icl_people_v1','icl_onboard_done_v1'].forEach(k=> localStorage.removeItem(k));
  try{ sessionStorage.clear(); }catch{}
  write(K_LOG, []); renderLog();
}

/* ===== APP INIT ===== */
document.addEventListener('DOMContentLoaded', () => {
  // Tabs
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => setTab(t.dataset.tab)));

  // Auth routing
  const sess = read(K_SESSION, 'null');
  if (sess && sess.user){ show('app'); renderProfile(sess.user); renderLog(); }
  else show('auth');

  // Login
  $('#login_btn').addEventListener('click', () => {
    const user = $('#login_user').value.trim();
    const pass = $('#login_pass').value;
    const u = findUser(user);
    if (!u || u.pass !== pass){
      $('#login_msg').textContent = '××©×ª××©/×¡×™×¡××” ×œ× × ×›×•× ×™×. ××¤×©×¨ ×œ×‘×¦×¢ Registration.';
      return;
    }
    write(K_SESSION, {user});
    $('#login_msg').textContent = '';
    show('app'); setTab('sos'); renderProfile(user); renderLog();
  });
  $('#linkReg').addEventListener('click', (e)=>{ e.preventDefault(); show('reg'); });

  // Registration
  $('#reg_cancel').addEventListener('click', ()=> show('auth'));
  $('#reg_save').addEventListener('click', () => {
    const user = $('#r_user').value.trim();
    const pass = $('#r_pass').value;
    const name = $('#r_name').value.trim();
    const phone = $('#r_phone').value.trim();
    const role = $('#r_role').value.trim();
    const area = $('#r_area').value.trim();
    const station = $('#r_station').value.trim();
    const email = $('#r_email').value.trim();

    if (!user || !pass || !name){ $('#reg_msg').textContent = '×©×“×•×ª ×—×•×‘×” ×—×¡×¨×™× (××¡×¤×¨ ××™×©×™, ×¡×™×¡××”, ×©× ××œ×).'; return; }
    if (phone && !phoneIL(phone)){ $('#reg_msg').textContent = '××¡×¤×¨ × ×™×™×“ ×œ× ×ª×§×™×Ÿ (05X-XXXXXXX).'; return; }

    const users = read(K_USERS,'[]');
    if (users.find(u => String(u.user)===String(user))){
      $('#reg_msg').textContent = '××©×ª××© ×§×™×™×. × ×¡×” ×œ×”×ª×—×‘×¨ ××• ×‘×—×¨ ××¡×¤×¨ ××™×©×™ ××—×¨.';
      return;
    }
    const rec = { user, pass, name, phone, role, area, station, email, createdAt: nowISO() };
    users.push(rec); write(K_USERS, users);
    // ××•×¡×™×¤×™× ×’× ×œ×‘× ×§ ×× ×©×™×
    upsertPerson({ id:user, user, name, phone, role, area, station, email });
    // ×›× ×™×¡×” ××•×˜×•××˜×™×ª
    write(K_SESSION, {user});
    $('#reg_msg').textContent = '';
    show('app'); setTab('sos'); renderProfile(user); renderLog();
  });

  // SOS buttons â†’ add to log
  document.querySelectorAll('.sos-btn').forEach(b => b.addEventListener('click', () => {
    const sess = read(K_SESSION, 'null'); if (!sess || !sess.user){ show('auth'); return; }
    const type = b.dataset.type;
    append(K_LOG, { ts: nowISO(), type, user: sess.user });
    renderLog();
    // ×¤×™×“×‘×§ ×§×¦×¨
    b.style.opacity = .8; setTimeout(()=> b.style.opacity=1, 120);
  }));

  // Log actions
  $('#clearLog').addEventListener('click', hardResetLog);

  // Logout
  $('#logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem(K_SESSION); show('auth'); });

  // People (optional)
  $('#peopleBtn').addEventListener('click', ()=>{ $('#peopleModal').classList.add('show'); renderPeopleModal(); });
  $('#peopleClose').addEventListener('click', ()=> $('#peopleModal').classList.remove('show'));
});
</script>

</body>
</html>
